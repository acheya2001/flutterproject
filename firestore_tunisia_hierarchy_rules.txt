// ğŸ‡¹ğŸ‡³ RÃ¨gles de sÃ©curitÃ© Firestore pour la hiÃ©rarchie tunisienne
// Structure: companies/{companyId}/agencies/{agencyId}
// Ã€ copier dans Firebase Console > Firestore Database > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ¢ COMPAGNIES - AccÃ¨s selon le rÃ´le
    match /companies/{companyId} {
      // Super Admin: accÃ¨s total
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
      
      // Admin Compagnie: accÃ¨s Ã  sa propre compagnie uniquement
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_compagnie" &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.compagnieId == companyId;
      
      // ğŸª AGENCES - Sous-collection des compagnies
      match /agencies/{agencyId} {
        // Super Admin: accÃ¨s total
        allow read, write: if request.auth != null &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
        
        // Admin Compagnie: accÃ¨s aux agences de sa compagnie
        allow read, write: if request.auth != null &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_compagnie" &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.compagnieId == companyId;
        
        // Admin Agence: accÃ¨s Ã  sa propre agence uniquement
        allow read, write: if request.auth != null &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_agence" &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.agenceId == agencyId &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.compagnieId == companyId;
        
        // Agent: lecture de sa propre agence
        allow read: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "agent" &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.agenceId == agencyId;
      }
    }
    
    // ğŸ‘¥ UTILISATEURS - Gestion des accÃ¨s
    match /users/{userId} {
      // Super Admin: accÃ¨s total
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
      
      // Admin Compagnie: accÃ¨s aux utilisateurs de sa compagnie
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_compagnie" &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.compagnieId == resource.data.compagnieId;
      
      // Admin Agence: accÃ¨s aux utilisateurs de son agence
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_agence" &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.agenceId == resource.data.agenceId;
      
      // Utilisateur: accÃ¨s Ã  son propre profil
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ğŸ“‹ SINISTRES - AccÃ¨s selon la hiÃ©rarchie
    match /sinistres/{sinistreId} {
      // Super Admin: accÃ¨s total
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
      
      // Admin Compagnie: sinistres de sa compagnie
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_compagnie" &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.compagnieId == resource.data.compagnieId;
      
      // Admin Agence: sinistres de son agence
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin_agence" &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.agenceId == resource.data.agenceId;
      
      // Expert: sinistres qui lui sont assignÃ©s
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "expert" &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.uid == resource.data.expertId;
    }
    
    // ğŸ‘¨â€ğŸ”§ EXPERTS - AccÃ¨s multi-compagnies
    match /experts/{expertId} {
      // Super Admin: accÃ¨s total
      allow read, write: if request.auth != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
      
      // Admin Compagnie et Admin Agence: lecture pour assignation
      allow read: if request.auth != null &&
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["admin_compagnie", "admin_agence"];
      
      // Expert: accÃ¨s Ã  son propre profil
      allow read, write: if request.auth != null &&
                        request.auth.uid == expertId;
    }
  }
}
