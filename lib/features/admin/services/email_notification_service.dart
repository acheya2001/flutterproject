import 'package:cloud_firestore/cloud_firestore.dart';import 'package:flutter/material.dart';import 'package:cloud_functions/cloud_functions.dart';import 'audit_logger_service.dart';  static final FirebaseFunctions _functions = FirebaseFunctions.instanceFor(region: 'europe-west1';  static const String _emailLogsCollection = 'email_logs';  static const String EMAIL_PASSWORD_RESET = 'password_reset';  static const String EMAIL_ACCOUNT_CREATED = 'account_created';  static const String EMAIL_ACCOUNT_APPROVED = 'account_approved';  static const String EMAIL_ACCOUNT_LOCKED = 'account_locked';  static const String EMAIL_ACCOUNT_UNLOCKED = 'account_unlocked';  static const String EMAIL_ACCOUNT_DISABLED = 'account_disabled';  static const String EMAIL_ROLE_CHANGED = 'role_changed';  static const String EMAIL_WELCOME = 'welcome';  static const String EMAIL_PASSWORD_CHANGED = ';  }';      debugPrint('[EMAIL_NOTIFICATION] 📧 Envoi notification reset password a: 'userEmail';        'type';        'to';        'subject': 'Votre mot de passe a ete reinitialise - Constat Tunisie';        'templateData';          'userName';          'temporaryPassword';          'adminName';          'companyName': companyName ?? 'Constat Tunisie';          'loginUrl': 'https://constat-tunisie.com/login';          'supportEmail': 'support@constat-tunisie.com';          ';      if (result';        // Logger l'envoi d'email dans l';          action: 'email_sent';          performedBy: 'system';            'emailType';            'success';            ';    } catch (e';      debugPrint(';  }';      debugPrint('[EMAIL_NOTIFICATION] 📧 Envoi notification creation compte a: 'userEmail';        'type';        'to';        'subject': 'Bienvenue sur Constat Tunisie - Votre compte a ete cree';        'templateData';          'userName';          'temporaryPassword';          'role';          'companyName': companyName ?? 'Constat Tunisie';          'agencyName';          'loginUrl': 'https://constat-tunisie.com/login';          'supportEmail': 'support@constat-tunisie.com';          ';      if (result';          action: 'email_sent';          performedBy: 'system';            'emailType';            'success';            ';    } catch (e';      debugPrint('[EMAIL_NOTIFICATION] ❌ Erreur envoi email creation compte:  + e.toString()';  /// ✅ Envoyer notification d';      debugPrint('[EMAIL_NOTIFICATION] 📧 Envoi notification approbation a: 'userEmail';        'type';        'to';        'subject': 'Votre compte a ete approuve - Constat Tunisie';        'templateData';          'userName';          'approvedBy';          'companyName': companyName ?? 'Constat Tunisie';          'loginUrl': 'https://constat-tunisie.com/login';          'supportEmail': 'support@constat-tunisie.com';          ';      if (result';          action: 'email_sent';          performedBy: 'system';            'emailType';            'success';            ';    } catch (e';      debugPrint(';  }';      debugPrint('[EMAIL_NOTIFICATION] 📧 Envoi notification blocage a: 'userEmail';        'type';        'to';        'subject': 'Votre compte a ete temporairement bloque - Constat Tunisie';        'templateData';          'userName';          'reason';          'lockedBy';          'companyName': companyName ?? 'Constat Tunisie';          'supportEmail': 'support@constat-tunisie.com';          ';      if (result';          action: 'email_sent';          performedBy: 'system';            'emailType';            'success';            'reason';            ';    } catch (e';      debugPrint(';  }';      debugPrint('[EMAIL_NOTIFICATION] 📧 Envoi notification deblocage a: 'userEmail';        'type';        'to';        'subject': 'Votre compte a ete debloque - Constat Tunisie';        'templateData';          'userName';          'unlockedBy';          'companyName': companyName ?? 'Constat Tunisie';          'loginUrl': 'https://constat-tunisie.com/login';          'supportEmail': 'support@constat-tunisie.com';          ';      if (result';          action: 'email_sent';          performedBy: 'system';            'emailType';            'success';            ';    } catch (e';      debugPrint(';  }';      debugPrint('[EMAIL_NOTIFICATION] 📧 Envoi notification desactivation a: 'userEmail';        'type';        'to';        'subject': 'Votre compte a ete desactive - Constat Tunisie';        'templateData';          'userName';          'disabledBy';          'reason': reason ?? 'Non specifiee';          'companyName': companyName ?? 'Constat Tunisie';          'supportEmail': 'support@constat-tunisie.com';          ';      if (result';          action: 'email_sent';          performedBy: 'system';            'emailType';            'success';            'disabledBy';            ';    } catch (e';      debugPrint('[EMAIL_NOTIFICATION] ❌ Erreur envoi email desactivation:  + e.toString()';  /// 📧 Methode privee pour envoyer l';      final emailLogId = await _logEmailAttempt(emailData';      // Utiliser la même methode que l';      final callable = _functions.httpsCallable('sendEmail';        'to': emailData['to';        'subject': emailData['subject';        ';      final result = await callable.call(gmailData';      final success = result.data['success';      await _updateEmailLog(emailLogId, success, result.data[';    } catch (e';      debugPrint('[EMAIL_NOTIFICATION] ❌ Erreur envoi email:  + e.toString()';  /// 📝 Logger une tentative d';      final logRef = _firestore.collection(_emailLogsCollection).doc(';        'id';        'type': emailData['type';        'to': emailData['to';        'subject': emailData['subject';        'status': 'pending';        'createdAt: FieldValue.serverTimestamp(';        'templateData': emailData[';    } catch (e';      debugPrint('[EMAIL_NOTIFICATION] ❌ Erreur log email:  + e.toString()';      return ';      await _firestore.collection(_emailLogsCollection).doc(logId';        'status': success ? 'sent' : 'failed';        'sentAt: success ? FieldValue.serverTimestamp(';        'error';        ';    } catch (e';      debugPrint('[EMAIL_NOTIFICATION] ❌ Erreur mise a jour log email:  + e.toString()';  /// 📊 Obtenir les statistiques d';      if (startDate != null';        query = query.where(';      if (endDate != null';        query = query.where(';      final logs = snapshot.docs.map((doc) => doc.data() as Map<String, dynamic>).toList(';        'total';        'sent: logs.where((log') => log['status'] == 'sent';        'failed: logs.where((log') => log['status'] == 'failed';        'pending: logs.where((log') => log['status'] == 'pending';        ';      for (final log in logs';        final type = log['type'] as String? ?? 'unknown';        final byTypeMap = stats[';    } catch (e';      debugPrint(';  static String _generateSimpleHtml(Map<String, dynamic> emailData';    final type = emailData['type'] ?? ';    final templateData = emailData[';    switch (type';        return ';            <h1>'{templateData['companyName'] ?? 'Constat Tunisie';            <h2>Bonjour '{templateData['userName'] ?? 'Utilisateur';            <p>Votre mot de passe a ete reinitialise par <strong>'{templateData['adminName'] ?? 'un administrateur';            <div class="password">'{templateData['temporaryPassword'] ?? 'N/A';                <a href="'{templateData['loginUrl'] ?? '#';            <p>Si vous n';                Email envoye automatiquement par '{templateData['companyName'] ?? 'Constat Tunisie';                📧 '{templateData['supportEmail'] ?? 'support@constat-tunisie.com';        ';        return ';            <h1>'{templateData['companyName'] ?? 'Constat Tunisie';            <h2>Bonne nouvelle, '{templateData['userName'] ?? 'Utilisateur';            <p>Votre compte a ete <strong>debloque</strong> par '{templateData['unlockedBy'] ?? 'un administrateur';                <a href="'{templateData['loginUrl'] ?? '#';                Email envoye automatiquement par '{templateData['companyName'] ?? 'Constat Tunisie';                📧 '{templateData['supportEmail'] ?? 'support@constat-tunisie.com';        ';        return ';            <h1>'{templateData['companyName'] ?? 'Constat Tunisie';            <h2>Bonjour '{templateData['userName'] ?? 'Utilisateur';                Email envoye automatiquement par '{templateData['companyName'] ?? 'Constat Tunisie';        ';