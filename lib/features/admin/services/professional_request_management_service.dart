import 'package:cloud_firestore/cloud_firestore.dart';import 'package:flutter/foundation.dart';import '../models/professional_request_model_final.dart';// import '../../../core/services/email_notification_service.dart';import '../../../core/services/approval_email_service.dart';import 'dart:math';  static const String _requestsCollection = 'demandes_professionnels';  static const String _usersCollection = 'users';        .where('status', isEqualTo: 'en_attente';          // Trier c√¥t√© client pour √©viter les probl√®mes d';      query = query.where('status';      query = query.where('role_demande';    // Pas d'orderBy pour √©viter les probl√®mes d';      debugPrint('[REQUEST_MANAGEMENT] ‚úÖ Approbation demande: $requestId';        throw Exception('Demande introuvable';        throw Exception('Erreur lors de la cr√©ation du compte';        'status': 'acceptee';        'approuve_par';        'approuve_le';        'commentaire_admin';        'user_id_cree';        'mot_de_passe_temporaire';        'updated_at';      // Envoyer l';        debugPrint('[REQUEST_MANAGEMENT] ‚ö†Ô∏è Email non envoy√© mais compte cr√©√©';      // Cr√©er une notification pour l';        title: 'Compte approuv√©';        message: 'Votre demande de compte professionnel a √©t√© approuv√©e. V√©rifiez votre email pour les d√©tails de connexion.';        type: 'account_approved';      debugPrint('[REQUEST_MANAGEMENT] ‚úÖ Demande approuv√©e avec succ√®s';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Erreur approbation: $e';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Rejet demande: $requestId';        throw Exception('Demande introuvable';        'status': 'rejetee';        'rejete_par';        'rejete_le';        'motif_rejet';        'commentaire_admin';        'updated_at';      // Envoyer l';        debugPrint('[REQUEST_MANAGEMENT] ‚ö†Ô∏è Email de rejet non envoy√©';      debugPrint('[REQUEST_MANAGEMENT] ‚úÖ Demande rejet√©e avec succ√®s';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Erreur rejet: $e';      // Cr√©er l'utilisateur dans Firestore (pas dans Auth pour l';        'email';        'nom_complet';        'telephone';        'cin';        'role';        'status': 'actif';        'mot_de_passe_temporaire';        'doit_changer_mot_de_passe';        'created_from_request';        'request_id';        'created_at';        'updated_at';        if (request.roleDemande == 'agent_agence';          'nom_agence';          'compagnie';          'adresse_agence';          'ville';        if (request.roleDemande == 'expert_auto';          'num_agrement';          'compagnie';          'zone_intervention';          'experience_annees';        if (request.roleDemande == 'admin_compagnie';          'nom_compagnie';          'fonction';          'adresse_siege';        if (request.roleDemande == 'admin_agence';          'nom_agence';          'compagnie';          'ville';          'adresse_agence';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Erreur cr√©ation utilisateur: $e';    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';  /// üîî Cr√©er une notification pour l';      await _firestore.collection('user_notifications';        'user_id';        'title';        'message';        'type';        'is_read';        'created_at';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Erreur notification: $e';            .where('status', isEqualTo: 'en_attente';            .where('envoye_le';        'en_attente';        'acceptee';        'rejetee';        'agent_agence';        'expert_auto';        'admin_compagnie';        'admin_agence';        final status = data['status'] ?? 'en_attente';        final role = data['role_demande'] ?? '';        'total';        'pending';        'this_month';        'by_status';        'by_role';        'approval_rate';            ? ((statusStats['acceptee';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Erreur statistiques: $e';        'total';        'pending';        'this_month';        'by_status';        'by_role';        'approval_rate';          .orderBy('envoye_le';      debugPrint('[REQUEST_MANAGEMENT] ‚ùå Erreur recherche: $e';