import 'package:cloud_firestore/cloud_firestore.dart';import 'package:firebase_auth/firebase_auth.dart';import 'package:flutter/foundation.dart';import '../models/agent_registration_model.dart';import '../../../core/services/debug_email_service.dart';/// ğŸ¢ Service d'inscription et d'approbation des agents d';  /// ğŸ“ Soumettre une demande d'inscription d';      debugPrint('[AgentRegistration] ğŸ“ DÃ©but inscription agent: $email';      // VÃ©rifier si l';          .collection('professional_account_requests';          .where('email';        throw Exception('Une demande existe dÃ©jÃ  pour cet email';      // CrÃ©er la demande d';        id: '';        status: 'pending';          .collection('professional_account_requests';      debugPrint('[AgentRegistration] âœ… Demande crÃ©Ã©e: ${docRef.id}';      // Envoyer notification Ã  l';      debugPrint('[AgentRegistration] âŒ Erreur inscription: $e';  /// ğŸ“§ Envoyer notification Ã  l';      await _firestore.collection('notifications';        'type': 'new_agent_request';        'title': 'Nouvelle demande d\'agent';        'message': 'Demande d\'inscription de ${registration.prenom} ${registration.nom} (${registration.compagnie})';        'requestId';        'userId': 'admin';        'isRead';        'createdAt';        'data';          'applicantName': '${registration.prenom} ${registration.nom}';          'company';          'email';      // Envoyer email Ã  l';      debugPrint('[AgentRegistration] ğŸ“§ Envoi email admin avec dÃ©buggage...';        to: 'constat.tunisie.app@gmail.com';        subject: 'ğŸ¢ Nouvelle demande d\'agent d\'assurance';        htmlBody: ''';          <h2 style="color: #2196F3;">ğŸ¢ Nouvelle demande d'agent d';            <p>Connectez-vous Ã  l';            Cette demande nÃ©cessite votre approbation avant que l';        ''';      // Analyser le rÃ©sultat de l';      debugPrint('[AgentRegistration] ğŸ“Š RÃ©sultat email admin:';      debugPrint('[AgentRegistration] - SuccÃ¨s: ${emailResult['success']}';      debugPrint('[AgentRegistration] - MÃ©thode: ${emailResult['method']}';      debugPrint('[AgentRegistration] - Ã‰tapes: ${emailResult['steps'].length}';      debugPrint('[AgentRegistration] - Erreurs: ${emailResult['errors'].length}';      if (emailResult['success';        debugPrint('[AgentRegistration] âœ… Notification admin envoyÃ©e via ${emailResult['method']}';        debugPrint('[AgentRegistration] âš ï¸ Notification admin Ã©chouÃ©e, mais inscription continue';      debugPrint('[AgentRegistration] âš ï¸ Erreur notification admin: $e';      // Ne pas faire Ã©chouer l';      debugPrint('[AgentRegistration] ğŸ“§ Envoi email confirmation avec dÃ©buggage...';        subject: 'ğŸ“ Demande d\'inscription reÃ§ue - Constat Tunisie';        htmlBody: ''';          <h2 style="color: #2196F3;">ğŸ“ Demande d';          <p>Nous avons bien reÃ§u votre demande d'inscription en tant qu'agent d';              <li>Votre demande est en cours d';              <li>Vous pourrez alors vous connecter Ã  l';          <p><strong>L';        ''';      // Analyser le rÃ©sultat de l';      debugPrint('[AgentRegistration] ğŸ“Š RÃ©sultat email confirmation:';      debugPrint('[AgentRegistration] - SuccÃ¨s: ${emailResult['success']}';      debugPrint('[AgentRegistration] - MÃ©thode: ${emailResult['method']}';      debugPrint('[AgentRegistration] - Ã‰tapes: ${emailResult['steps'].length}';      debugPrint('[AgentRegistration] - Erreurs: ${emailResult['errors'].length}';      if (emailResult['success';        debugPrint('[AgentRegistration] âœ… Email confirmation envoyÃ© via ${emailResult['method']}';        debugPrint('[AgentRegistration] âš ï¸ Email confirmation Ã©chouÃ©, mais inscription continue';      debugPrint('[AgentRegistration] âš ï¸ Erreur email confirmation: $e';      // Ne pas faire Ã©chouer l'inscription si l';  /// âœ… Approuver une demande d';      debugPrint('[AgentRegistration] âœ… Approbation demande: $requestId';          .collection('professional_account_requests';        throw Exception('Demande non trouvÃ©e';      debugPrint('[AgentRegistration] âœ… Compte Firebase crÃ©Ã©: ${userCredential.user?.uid}';      await _firestore.collection('users';        'email';        'userType': 'assureur';        'role': 'assureur';        'accountStatus': 'active';        'createdAt';        'approvedAt';        'approvedBy';      await _firestore.collection('assureurs';        'uid';        'email';        'prenom';        'nom';        'telephone';        'compagnie';        'agence';        'gouvernorat';        'poste';        'numeroAgent';        'carteIdRecto';        'carteIdVerso';        'permisRecto';        'permisVerso';        'isActive';        'createdAt';        'approvedAt';        'approvedBy';      await _firestore.collection('professional_account_requests';        'status': 'approved';        'reviewedAt';        'reviewedBy';        'agentUid';      // Envoyer email d';      debugPrint('[AgentRegistration] âœ… Agent approuvÃ© avec succÃ¨s';      debugPrint('[AgentRegistration] âŒ Erreur approbation: $e';  /// ğŸ“§ Envoyer email d';      debugPrint('[AgentRegistration] ğŸ“§ Envoi email approbation avec dÃ©buggage...';        subject: 'ğŸ‰ Compte agent approuvÃ© - Constat Tunisie';        htmlBody: ''';          <p>Excellente nouvelle ! Votre demande d'inscription en tant qu'agent d';            <p><strong>Vous pouvez maintenant vous connecter Ã  l';              <li>Gestion des contrats d';              <li>Rapports d';          <p>Bienvenue dans l';          <p><strong>L';        ''';      // Analyser le rÃ©sultat de l';      debugPrint('[AgentRegistration] ğŸ“Š RÃ©sultat email approbation:';      debugPrint('[AgentRegistration] - SuccÃ¨s: ${emailResult['success']}';      debugPrint('[AgentRegistration] - MÃ©thode: ${emailResult['method']}';      debugPrint('[AgentRegistration] - Ã‰tapes: ${emailResult['steps'].length}';      debugPrint('[AgentRegistration] - Erreurs: ${emailResult['errors'].length}';      if (emailResult['success';        debugPrint('[AgentRegistration] âœ… Email approbation envoyÃ© via ${emailResult['method']}';        debugPrint('[AgentRegistration] âš ï¸ Email approbation Ã©chouÃ©';      debugPrint('[AgentRegistration] âš ï¸ Erreur email approbation: $e';  /// âŒ Rejeter une demande d';      debugPrint('[AgentRegistration] âŒ Rejet demande: $requestId';          .collection('professional_account_requests';        throw Exception('Demande non trouvÃ©e';      await _firestore.collection('professional_account_requests';        'status': 'rejected';        'reviewedAt';        'reviewedBy';        'rejectionReason';      debugPrint('[AgentRegistration] âœ… Demande rejetÃ©e';      debugPrint('[AgentRegistration] âŒ Erreur rejet: $e';      debugPrint('[AgentRegistration] ğŸ“§ Envoi email rejet avec dÃ©buggage...';        subject: 'âŒ Demande d\'inscription non approuvÃ©e - Constat Tunisie';        htmlBody: ''';          <p>Nous vous remercions pour votre demande d'inscription en tant qu'agent d';            <p>Si vous pensez qu';          <p><strong>L';        ''';      // Analyser le rÃ©sultat de l';      debugPrint('[AgentRegistration] ğŸ“Š RÃ©sultat email rejet:';      debugPrint('[AgentRegistration] - SuccÃ¨s: ${emailResult['success']}';      debugPrint('[AgentRegistration] - MÃ©thode: ${emailResult['method']}';      debugPrint('[AgentRegistration] - Ã‰tapes: ${emailResult['steps'].length}';      debugPrint('[AgentRegistration] - Erreurs: ${emailResult['errors'].length}';      if (emailResult['success';        debugPrint('[AgentRegistration] âœ… Email rejet envoyÃ© via ${emailResult['method']}';        debugPrint('[AgentRegistration] âš ï¸ Email rejet Ã©chouÃ©';      debugPrint('[AgentRegistration] âš ï¸ Erreur email rejet: $e';          .collection('professional_account_requests';          .where('status', isEqualTo: 'pending';          .orderBy('submittedAt';      debugPrint('[AgentRegistration] âŒ Erreur rÃ©cupÃ©ration demandes: $e';          .collection('professional_account_requests';        'total';        'pending';        'approved';        'rejected';        final status = doc.data()['status'] as String? ?? 'pending';        stats['total'] = (stats['total';      debugPrint('[AgentRegistration] âŒ Erreur statistiques: $e';      return {'total': 0, 'pending': 0, 'approved': 0, 'rejected';