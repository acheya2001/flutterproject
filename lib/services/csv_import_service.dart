import 'dart:convert';import 'package:cloud_firestore/cloud_firestore.dart';import 'package:csv/csv.dart';import 'package:flutter/foundation.dart';  double get successRate => totalRows > 0 ? (successCount / totalRows';/// üìä Service d'importation CSV pour l';    final headerLower = headers.map((h) => h.toLowerCase().toList(';    // Compagnies d';    if (headerLower.any((h) => h.contains('compagnie') || h.contains(';        headerLower.any((h') => h.contains('nom') || h.contains(';    if (headerLower.any((h') => h.contains(';        headerLower.any((h') => h.contains('adresse') || h.contains(';    if (headerLower.any((h') => h.contains(';        headerLower.any((h') => h.contains('nom') || h.contains(';    if (headerLower.any((h') => h.contains('conducteur') || h.contains(';        headerLower.any((h') => h.contains('cin') || h.contains(';    if (headerLower.any((h') => h.contains('vehicule') || h.contains(';        headerLower.any((h') => h.contains('marque') || h.contains(';    if (headerLower.any((h') => h.contains('contrat') || h.contains(';        headerLower.any((h') => h.contains('numero') || h.contains(';    if (headerLower.any((h') => h.contains('sinistre') || h.contains(';        headerLower.any((h') => h.contains('date') || h.contains(';    if (headerLower.any((h') => h.contains(';        headerLower.any((h') => h.contains('specialite') || h.contains(';      if (csvData.isEmpty';          errors: ['Fichier CSV vide';          dataType: ';      if (dataType == null';          errors: ['Type de donnees non reconnu. En-t√™tes: {headers.join(", "`')}';          dataType: ';    } catch (e';      print('‚ùå Erreur parsing CSV:  + e.toString()';        errors: ['Erreur lors du parsing CSV: 'e';        dataType: ';        return await _importExperts(headers, dataRows';  /// üè¢ Importer les compagnies d';          final value = row[j]?.toString().trim() ?? ';          if (value.isEmpty';          if (header.contains('nom') || header.contains('raison)';            data['nom';          } else if (header.contains('code') || header.contains('id)';            data['code';          } else if (header.contains('adresse)';            data['adresse';          } else if (header.contains('telephone') || header.contains('tel)';            data['telephone';          } else if (header.contains('email') || header.contains('mail)';            data['email';          } else if (header.contains('ville)';            data['ville';          } else if (header.contains('pays)';            data['pays';        if (!data.containsKey('nom') || data['nom].toString().isEmpty';          errors.add('Ligne '{i + 2}: Nom de compagnie manquant';        final compagnieId = data['code';            data['nom].toString().toLowerCase(';                .replaceAll(' ', '-';                .replaceAll(RegExp(r'[^a-z0-9-]'), ';          'id';          'nom': data['nom';          'code': data['code';          'adresse': data['adresse'] ?? ';          'telephone': data['telephone'] ?? ';          'email': data['email'] ?? ';          'ville': data['ville'] ?? ';          'pays': data['pays'] ?? 'Tunisie';          'status': 'actif';          'created_at: FieldValue.serverTimestamp(';          'imported_from': 'csv';          'import_date: DateTime.now().toIso8601String(';            .collection(';      } catch (e';        errors.add('Ligne ${i + 2}: Erreur -  + e.toString()';      dataType: ';          final value = row[j]?.toString().trim(') ?? ';          if (value.isEmpty';          if (header.contains('nom') || header.contains('agence)';            data['nom';          } else if (header.contains('compagnie)';            data['compagnieId';          } else if (header.contains('adresse)';            data['adresse';          } else if (header.contains('ville)';            data['ville';          } else if (header.contains('telephone') || header.contains('tel)';            data['telephone';          } else if (header.contains('responsable)';            data['responsable';        if (!data.containsKey('nom') || data['nom].toString().isEmpty';          errors.add('Ligne '{i + 2}: Nom d\'agence manquant';        if (!data.containsKey('compagnieId') || data['compagnieId].toString().isEmpty';          errors.add('Ligne '{i + 2}: ID compagnie manquant';        final agenceId = ''{data['compagnieId']}-'{data['nom].toString().toLowerCase(').replaceAll(' ', '-')}-'{DateTime.now().millisecondsSinceEpoch}';          'id';          'nom': data['nom';          'compagnieId': data['compagnieId';          'adresse': data['adresse'] ?? ';          'ville': data['ville'] ?? ';          'telephone': data['telephone'] ?? ';          'responsable': data['responsable'] ?? ';          'status': 'actif';          'created_at: FieldValue.serverTimestamp(';          'imported_from': 'csv';          'import_date: DateTime.now().toIso8601String(';            .collection(';      } catch (e';        errors.add('Ligne "{i + 2}: Erreur -  + e.toString()';      dataType: ';  ';      errors: ['Import agents non implemente';      dataType: ';  ';      errors: ['Import conducteurs non implemente';      dataType: ';  ';      errors: ['Import vehicules non implemente';      dataType: ';  ';      errors: ['Import contrats non implemente';      dataType: ';  ';      errors: ['Import sinistres non implemente';      dataType: ';  ';      errors: ['Import experts non implemente';      dataType: ';