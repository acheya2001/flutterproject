import 'package:cloud_firestore/cloud_firestore.dart';import 'package:flutter/foundation.dart';import 'dart:math';    'super_admin';      'create_company';      'create_agency';      'manage_all_companies';      'manage_all_agencies';      'create_admin_compagnie';      'create_admin_agence';      'view_all_data';    'admin_compagnie';      'create_agency_own_company';      'manage_own_agencies';      'create_admin_agence';      'create_agent';      'view_own_company_data';      'manage_own_company_sinistres';    'admin_agence';      'manage_own_agency';      'create_agent';      'manage_own_agents';      'view_own_agency_data';      'manage_own_agency_sinistres';    'agent';      'create_constat';      'view_own_constats';      'manage_clients';      'create_contrat';    'expert';      'view_assigned_sinistres';      'create_expertise_report';      'update_sinistre_status';    return permissions.contains(permission';  /// üè¢ Creer une compagnie d';      if (!hasPermission(userRole, 'create_company)';          'success';          'error': 'Permission refusee';          'message': 'Seul le Super Admin peut creer des compagnies';      debugPrint('[TUNISIA_HIERARCHY] üè¢ Creation compagnie: 'nom';      final compagnieId = 'comp_${code.toLowerCase()}_{DateTime.now(').millisecondsSinceEpoch}';        'id';        'nom';        'code: code.toUpperCase(';        'adresse';        'telephone';        'email';        'logoUrl';        'status': 'actif';        'isActive';        'created_at: FieldValue.serverTimestamp(';        'created_by';        'updated_at: FieldValue.serverTimestamp(';        'stats';          'total_agences';          'total_agents';          'total_contrats';          'total_sinistres';          'chiffre_affaires';          .collection(';          .set(compagnieData';      debugPrint('[TUNISIA_HIERARCHY] ‚úÖ Compagnie creee: 'compagnieId';        'success';        'compagnieId';        'message': 'Compagnie creee avec succes';        ';    } catch (e';      debugPrint('[TUNISIA_HIERARCHY] ‚ùå Erreur creation compagnie:  + e.toString()';        'success';        'error: e.toString(';        'message': ';  }';      bool canCreate = hasPermission(userRole, 'create_agency';                      hasPermission(userRole, ';      if (!canCreate';          'success';          'error': 'Permission refusee';          'message': 'Vous n\'avez pas le droit de creer des agences';      debugPrint('[TUNISIA_HIERARCHY] üè™ Creation agence: 'nom';      final agenceId = 'agence_${compagnieId}_{DateTime.now(').millisecondsSinceEpoch}';        'id';        'compagnieId';        'nom';        'code';        'ville';        'gouvernorat';        'adresse';        'telephone';        'email';        'responsable': responsable ?? ';        'horaires: horaires ?? _getDefaultHoraires(';        'status': 'actif';        'isActive';        'created_at: FieldValue.serverTimestamp(';        'created_by';        'updated_at: FieldValue.serverTimestamp(';        'stats';          'total_agents';          'total_contrats';          'total_sinistres';          'chiffre_affaires_mensuel';          .collection(';          .doc(compagnieId';          .collection(';          .set(agenceData';          .collection(';          .doc(compagnieId';        'stats.total_agences: FieldValue.increment(1';        ';      }';      debugPrint('[TUNISIA_HIERARCHY] ‚úÖ Agence creee: 'agenceId';        'success';        'agenceId';        'message': 'Agence creee avec succes';        ';    } catch (e';      debugPrint('[TUNISIA_HIERARCHY] ‚ùå Erreur creation agence:  + e.toString()';        'success';        'error: e.toString(';        'message': 'Erreur lors de la creation de l\';  }';      if (!hasPermission(userRole, 'create_admin_agence)';          'success';          'error': 'Permission refusee';          'message': 'Vous n\'avez pas le droit de creer des Admin Agence';      debugPrint('[TUNISIA_HIERARCHY] üë§ Creation Admin Agence: $prenom 'nom';      // Verifier que l';          .collection(';          .doc(compagnieId';          .collection(';      if (!agenceDoc.exists';          'success';          'error': 'Agence introuvable';          'message': 'L\'agence specifiee n\'existe pas';      // Verifier qu'il n';          .collection('users';          .where('role', isEqualTo: 'admin_agence';          .where(';      if (existingAdmin.docs.isNotEmpty';          'success';          'error': 'Admin deja existant';          'message': ';      final tempPassword = _generateTempPassword(';      final adminId = 'admin_agence_${agenceId}_{DateTime.now(').millisecondsSinceEpoch}';        'uid';        'email';        'nom';        'prenom';        'role': 'admin_agence';        'compagnieId';        'agenceId';        'telephone';        'adresse': adresse ?? ';        'cin': cin ?? ';        'status': 'actif';        'isActive';        'isFirstLogin';        'passwordChangeRequired';        'created_at: FieldValue.serverTimestamp(';        'created_by';        'updated_at: FieldValue.serverTimestamp(';        'password';        'temporaryPassword';        'motDePasseTemporaire';        'motDePasse';        'temp_password';        'generated_password';          .collection(';          .set(adminData';      // Mettre a jour l'agence avec l';          .collection(';          .doc(compagnieId';          .collection(';          .doc(agenceId';        'adminUid';        'adminEmail';        ';      }';      debugPrint('[TUNISIA_HIERARCHY] ‚úÖ Admin Agence cree: 'adminId';        'success';        'adminId';        'email';        'password';        'message': 'Admin Agence cree avec succes';        'displayCredentials';          'email';          'password';          'nom': '$prenom 'nom';          'role': ';    } catch (e';      debugPrint('[TUNISIA_HIERARCHY] ‚ùå Erreur creation Admin Agence:  + e.toString()';        'success';        'error: e.toString(';        'message': 'Erreur lors de la creation de l\'Admin Agence';  }';      debugPrint('[TUNISIA_HIERARCHY] üìã Recuperation agences compagnie: 'compagnieId';      if (!hasPermission(userRole, 'view_own_company_data';          !hasPermission(userRole, 'view_all_data)';          .collection(';          .doc(compagnieId';          .collection('agencies';          .where(';        final data = doc.data(';        data[';      agences.sort((a, b') => (a['nom'] ?? ').compareTo(b['nom'] ?? ')';      debugPrint('[TUNISIA_HIERARCHY] ‚úÖ ';    } catch (e';      debugPrint('[TUNISIA_HIERARCHY] ‚ùå Erreur recuperation agences:  + e.toString()';  /// üîß Generer un code d';    final nomCode = nom.replaceAll(' ', ').toUpperCase().substring(0, 3.clamp(0, nom.length)';    final villeCode = ville.replaceAll(' ', ';    final timestamp = DateTime.now().millisecondsSinceEpoch.toString().substring(8';    return '$nomCode$villeCode';  static String _generateTempPassword(';    const chars = ';  static Map<String, String> _getDefaultHoraires(';      'lundi': '08:00-17:00';      'mardi': '08:00-17:00';      'mercredi': '08:00-17:00';      'jeudi': '08:00-17:00';      'vendredi': '08:00-17:00';      'samedi': '08:00-12:00';      'dimanche': 'Ferme';