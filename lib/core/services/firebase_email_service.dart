import 'package:cloud_functions/cloud_functions.dart';import 'package:flutter/foundation.dart';/// 🔥 Service d';  static final FirebaseFunctions _functions = FirebaseFunctions.instanceFor(region: 'europe-west1';      debugPrint('[FirebaseEmail] === ENVOI INVITATION VIA GMAIL API ===';      debugPrint('[FirebaseEmail] 📧 Destinataire: $email';      debugPrint('[FirebaseEmail] 🔑 Code session: $sessionCode';      debugPrint('[FirebaseEmail] 🆔 ID session: $sessionId';      // Validation de l';        throw Exception('Format d\'email invalide: $email';            customMessage: customMessage ?? 'Votre compte a été traité.';            customMessage: customMessage ?? 'Un conducteur vous invite à rejoindre une session de constat collaboratif.';      final HttpsCallable callable = _functions.httpsCallable('sendEmail';        'to';        'subject': customSubject ?? '🚗 Invitation au constat - Code: $sessionCode';        'html';        'sessionCode';        'sessionId';        'conducteurNom': 'Un conducteur';      debugPrint('[FirebaseEmail] ✅ Réponse Gmail API: ${result.data}';      if (result.data != null && result.data['success';        debugPrint('[FirebaseEmail] 🎉 Email envoyé avec succès!';        debugPrint('[FirebaseEmail] ❌ Échec de l\'envoi: ${result.data?['message'] ?? 'Réponse invalide'}';      debugPrint('[FirebaseEmail] ❌ Erreur lors de l\'envoi Gmail: $e';      // Si l';      // on peut considérer que l';      if (e.toString().contains('INTERNAL';        debugPrint('[FirebaseEmail] ⚠️ Erreur INTERNAL mais email probablement envoyé (vérifiez les logs Firebase)';        // Pour l';      debugPrint('[FirebaseEmail] === ENVOI NOTIFICATION COMPTE ===';      debugPrint('[FirebaseEmail] 📧 Destinataire: $email';      debugPrint('[FirebaseEmail] 👤 Utilisateur: $userName';      debugPrint('[FirebaseEmail] ✅ Approuvé: $isApproved';        throw Exception('Format d\'email invalide: $email';        ? '✅ Votre compte Constat Tunisie a été approuvé !';        : '❌ Votre demande de compte Constat Tunisie';      final HttpsCallable callable = _functions.httpsCallable('sendEmail';        'to';        'subject';        'html';      debugPrint('[FirebaseEmail] ✅ Réponse Gmail API: ${result.data}';      return result.data['success';      debugPrint('[FirebaseEmail] ❌ Erreur envoi notification compte: $e';      debugPrint('[FirebaseEmail] === ENVOI EMAIL SIMPLE ===';      debugPrint('[FirebaseEmail] 📧 Destinataire: $to';      debugPrint('[FirebaseEmail] 🏷️ Sujet: $subject';        throw Exception('Format d\'email invalide: $to';      final HttpsCallable callable = _functions.httpsCallable('sendEmail';        'to';        'subject';        if (isHtml) 'html': body else 'text';      debugPrint('[FirebaseEmail] ✅ Réponse Gmail API: ${result.data}';      return result.data['success';      debugPrint('[FirebaseEmail] ❌ Erreur lors de l\'envoi: $e';  /// ✅ Valide le format d';    return RegExp(r'^[^@]+@[^@]+\.[^@]+$';    final userTypeLabel = userType == 'assureur' ? 'Agent d\'Assurance' : 'Expert';      return ''';                  <li>Vous pouvez vous connecter à l';                <strong>L';      ''';      return ''';                  ${rejectionReason ?? 'Informations insuffisantes ou critères non remplis';                Pour toute question, n';                <strong>L';      ''';  /// 🎨 Crée le contenu HTML de l'email d';    return ''';        <title>Invitation - Constat d';              <h2 style="color: #2563eb; margin: 0;">Invitation - Constat d';              <p>Vous avez été invité(e) à participer à un constat d'accident collaboratif via l';                <li>Ouvrez l';            <!-- Bouton d';                <li>Ayez vos documents à portée de main (permis, carte grise, attestation d';                <li>Prenez des photos de l'accident si ce n';                <li>Assurez-vous d';              <p>Cet email a été envoyé automatiquement par l';              <p>Si vous n';              <p style="margin-top: 15px;"><strong>Constat Tunisie</strong> - Votre assistant pour les constats d';    ''';      debugPrint('[FirebaseEmail] 📧 Envoi email compte professionnel à: $email';      debugPrint('[FirebaseEmail] 📧 Sujet: $sujet';      debugPrint('[FirebaseEmail] 📧 Titre: $titre';      // Validation de l';        throw Exception('Format d\'email invalide: $email';      debugPrint('[FirebaseEmail] 🔧 Génération du template HTML...';      debugPrint('[FirebaseEmail] ✅ Template HTML généré (${htmlContent.length} caractères)';      debugPrint('[FirebaseEmail] 🔧 Appel de la fonction Firebase...';        debugPrint('[FirebaseEmail] 🎉 Email compte professionnel envoyé avec succès!';        debugPrint('[FirebaseEmail] ❌ Échec de l\'envoi de l\'email';      debugPrint('[FirebaseEmail] ❌ Erreur lors de l\'envoi de l\'email: $e';      debugPrint('[FirebaseEmail] ❌ Stack trace: ${StackTrace.current}';    return ''';            body { font-family: 'Segoe UI';                <p>Cet email a été envoyé automatiquement par l';                <p><strong>Constat Tunisie</strong> - Votre plateforme de gestion des constats d';    ''';    return ''';              <p>Cet email a été envoyé automatiquement par l';              <p><strong>Constat Tunisie</strong> - Votre plateforme de gestion des constats d';    ''';