import 'package:cloud_functions/cloud_functions.dart';import 'package:flutter/foundation.dart';/// ğŸ”¥ Service d';  static final FirebaseFunctions _functions = FirebaseFunctions.instanceFor(region: 'europe-west1';      debugPrint('[FirebaseEmail] === ENVOI INVITATION VIA GMAIL API ===';      debugPrint('[FirebaseEmail] ğŸ“§ Destinataire: $email';      debugPrint('[FirebaseEmail] ğŸ”‘ Code session: $sessionCode';      debugPrint('[FirebaseEmail] ğŸ†” ID session: $sessionId';      // Validation de l';        throw Exception('Format d\'email invalide: $email';            customMessage: customMessage ?? 'Votre compte a Ã©tÃ© traitÃ©.';            customMessage: customMessage ?? 'Un conducteur vous invite Ã  rejoindre une session de constat collaboratif.';      final HttpsCallable callable = _functions.httpsCallable('sendEmail';        'to';        'subject': customSubject ?? 'ğŸš— Invitation au constat - Code: $sessionCode';        'html';        'sessionCode';        'sessionId';        'conducteurNom': 'Un conducteur';      debugPrint('[FirebaseEmail] âœ… RÃ©ponse Gmail API: ${result.data}';      if (result.data != null && result.data['success';        debugPrint('[FirebaseEmail] ğŸ‰ Email envoyÃ© avec succÃ¨s!';        debugPrint('[FirebaseEmail] âŒ Ã‰chec de l\'envoi: ${result.data?['message'] ?? 'RÃ©ponse invalide'}';      debugPrint('[FirebaseEmail] âŒ Erreur lors de l\'envoi Gmail: $e';      // Si l';      // on peut considÃ©rer que l';      if (e.toString().contains('INTERNAL';        debugPrint('[FirebaseEmail] âš ï¸ Erreur INTERNAL mais email probablement envoyÃ© (vÃ©rifiez les logs Firebase)';        // Pour l';      debugPrint('[FirebaseEmail] === ENVOI NOTIFICATION COMPTE ===';      debugPrint('[FirebaseEmail] ğŸ“§ Destinataire: $email';      debugPrint('[FirebaseEmail] ğŸ‘¤ Utilisateur: $userName';      debugPrint('[FirebaseEmail] âœ… ApprouvÃ©: $isApproved';        throw Exception('Format d\'email invalide: $email';        ? 'âœ… Votre compte Constat Tunisie a Ã©tÃ© approuvÃ© !';        : 'âŒ Votre demande de compte Constat Tunisie';      final HttpsCallable callable = _functions.httpsCallable('sendEmail';        'to';        'subject';        'html';      debugPrint('[FirebaseEmail] âœ… RÃ©ponse Gmail API: ${result.data}';      return result.data['success';      debugPrint('[FirebaseEmail] âŒ Erreur envoi notification compte: $e';      debugPrint('[FirebaseEmail] === ENVOI EMAIL SIMPLE ===';      debugPrint('[FirebaseEmail] ğŸ“§ Destinataire: $to';      debugPrint('[FirebaseEmail] ğŸ·ï¸ Sujet: $subject';        throw Exception('Format d\'email invalide: $to';      final HttpsCallable callable = _functions.httpsCallable('sendEmail';        'to';        'subject';        if (isHtml) 'html': body else 'text';      debugPrint('[FirebaseEmail] âœ… RÃ©ponse Gmail API: ${result.data}';      return result.data['success';      debugPrint('[FirebaseEmail] âŒ Erreur lors de l\'envoi: $e';  /// âœ… Valide le format d';    return RegExp(r'^[^@]+@[^@]+\.[^@]+$';    final userTypeLabel = userType == 'assureur' ? 'Agent d\'Assurance' : 'Expert';      return ''';                  <li>Vous pouvez vous connecter Ã  l';                <strong>L';      ''';      return ''';                  ${rejectionReason ?? 'Informations insuffisantes ou critÃ¨res non remplis';                Pour toute question, n';                <strong>L';      ''';  /// ğŸ¨ CrÃ©e le contenu HTML de l'email d';    return ''';        <title>Invitation - Constat d';              <h2 style="color: #2563eb; margin: 0;">Invitation - Constat d';              <p>Vous avez Ã©tÃ© invitÃ©(e) Ã  participer Ã  un constat d'accident collaboratif via l';                <li>Ouvrez l';            <!-- Bouton d';                <li>Ayez vos documents Ã  portÃ©e de main (permis, carte grise, attestation d';                <li>Prenez des photos de l'accident si ce n';                <li>Assurez-vous d';              <p>Cet email a Ã©tÃ© envoyÃ© automatiquement par l';              <p>Si vous n';              <p style="margin-top: 15px;"><strong>Constat Tunisie</strong> - Votre assistant pour les constats d';    ''';      debugPrint('[FirebaseEmail] ğŸ“§ Envoi email compte professionnel Ã : $email';      debugPrint('[FirebaseEmail] ğŸ“§ Sujet: $sujet';      debugPrint('[FirebaseEmail] ğŸ“§ Titre: $titre';      // Validation de l';        throw Exception('Format d\'email invalide: $email';      debugPrint('[FirebaseEmail] ğŸ”§ GÃ©nÃ©ration du template HTML...';      debugPrint('[FirebaseEmail] âœ… Template HTML gÃ©nÃ©rÃ© (${htmlContent.length} caractÃ¨res)';      debugPrint('[FirebaseEmail] ğŸ”§ Appel de la fonction Firebase...';        debugPrint('[FirebaseEmail] ğŸ‰ Email compte professionnel envoyÃ© avec succÃ¨s!';        debugPrint('[FirebaseEmail] âŒ Ã‰chec de l\'envoi de l\'email';      debugPrint('[FirebaseEmail] âŒ Erreur lors de l\'envoi de l\'email: $e';      debugPrint('[FirebaseEmail] âŒ Stack trace: ${StackTrace.current}';    return ''';            body { font-family: 'Segoe UI';                <p>Cet email a Ã©tÃ© envoyÃ© automatiquement par l';                <p><strong>Constat Tunisie</strong> - Votre plateforme de gestion des constats d';    ''';    return ''';              <p>Cet email a Ã©tÃ© envoyÃ© automatiquement par l';              <p><strong>Constat Tunisie</strong> - Votre plateforme de gestion des constats d';    ''';