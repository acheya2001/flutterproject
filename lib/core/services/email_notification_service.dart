import 'package:cloud_firestore/cloud_firestore.dart';import 'package:cloud_functions/cloud_functions.dart';import 'package:flutter/foundation.dart';  /// üìß Envoyer un email de confirmation d';      debugPrint('[EMAIL_SERVICE] üìß Envoi email acceptation √†: $email';      final callable = _functions.httpsCallable('sendAcceptanceEmail';        'email';        'nomComplet';        'role';        'motDePasse';        'appName': 'Constat Tunisie';        'loginUrl': 'https://constat-tunisie.app/login';      if (result.data['success';        debugPrint('[EMAIL_SERVICE] ‚úÖ Email acceptation envoy√© avec succ√®s';        // Enregistrer l';          type: 'acceptance';          status: 'sent';            'nom_complet';            'role';        throw Exception(result.data['error'] ?? 'Erreur inconnue';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur envoi email acceptation: $e';      // Enregistrer l';        type: 'acceptance';        status: 'failed';      debugPrint('[EMAIL_SERVICE] üìß Envoi email rejet √†: $email';      final callable = _functions.httpsCallable('sendRejectionEmail';        'email';        'nomComplet';        'role';        'motifRejet';        'appName': 'Constat Tunisie';        'supportEmail': 'support@constat-tunisie.app';      if (result.data['success';        debugPrint('[EMAIL_SERVICE] ‚úÖ Email rejet envoy√© avec succ√®s';        // Enregistrer l';          type: 'rejection';          status: 'sent';            'nom_complet';            'role';            'motif_rejet';        throw Exception(result.data['error'] ?? 'Erreur inconnue';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur envoi email rejet: $e';      // Enregistrer l';        type: 'rejection';        status: 'failed';      debugPrint('[EMAIL_SERVICE] üìß Notification nouvelle demande aux admins';      final callable = _functions.httpsCallable('sendNewRequestNotification';        'nomComplet';        'email';        'role';        'requestId';        'adminEmail': 'constat.tunisie.app@gmail.com';        'dashboardUrl': 'https://admin.constat-tunisie.app/requests';      if (result.data['success';        debugPrint('[EMAIL_SERVICE] ‚úÖ Notification admin envoy√©e avec succ√®s';        throw Exception(result.data['error'] ?? 'Erreur inconnue';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur notification admin: $e';  /// üìù Enregistrer l'envoi d';      await _firestore.collection('email_logs';        'email';        'type': type, // 'acceptance', 'rejection', 'notification';        'status': status, // 'sent', 'failed';        'details';        'error';        'sent_at';        'created_at';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur log email: $e';  /// üìä Obtenir les statistiques d'envoi d';          .collection('email_logs';          .where('sent_at';        'total_today';        'sent_today';        'failed_today';        'by_type';        final status = data['status';        final type = data['type';        if (status == 'sent';          stats['sent_today'] = (stats['sent_today';        } else if (status == 'failed';          stats['failed_today'] = (stats['failed_today';        final byType = stats['by_type';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur stats email: $e';        'total_today';        'sent_today';        'failed_today';        'by_type';  /// üîÑ R√©essayer l'envoi d';      final doc = await _firestore.collection('email_logs';        throw Exception('Log email introuvable';      final email = data['email';      final type = data['type';      final details = data['details';        case 'acceptance';            nomComplet: details['nom_complet'] ?? '';            role: details['role'] ?? '';            motDePasse: details['mot_de_passe'] ?? '';        case 'rejection';            nomComplet: details['nom_complet'] ?? '';            role: details['role'] ?? '';            motifRejet: details['motif_rejet'] ?? '';        // Marquer l';        await _firestore.collection('email_logs';          'retried_at';          'retry_success';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur retry email: $e';      final callable = _functions.httpsCallable('testEmailConfig';        'testEmail': 'constat.tunisie.app@gmail.com';      return result.data['success';      debugPrint('[EMAIL_SERVICE] ‚ùå Erreur test config: $e';